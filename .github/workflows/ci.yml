# CIB-Med-1 Continuous Integration
# ================================
# Runs on every push and pull request to ensure code quality

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  # ============================================
  # Code Quality Checks
  # ============================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 isort

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff --profile black cib_med/ || true

      - name: Lint with flake8 (warnings only)
        run: |
          # Stop the build only on syntax errors or undefined names
          flake8 cib_med/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Treat all other issues as warnings
          flake8 cib_med/ --count --exit-zero --max-complexity=15 --max-line-length=120 --statistics

  # ============================================
  # Unit Tests
  # ============================================
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install numpy scipy scikit-learn pandas Pillow matplotlib seaborn PyYAML tqdm
          pip install pytest pytest-cov

      - name: Install package
        run: |
          pip install -e .

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short -x || true

  # ============================================
  # Package Build Verification
  # ============================================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Build package
        run: |
          python -m build

      - name: Check package
        run: |
          pip install twine
          twine check dist/*

  # ============================================
  # Documentation Check
  # ============================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README exists
        run: test -f README.md

      - name: Check LICENSE exists
        run: test -f LICENSE

      - name: Check required files
        run: |
          test -f requirements.txt
          test -f setup.py
          test -f pyproject.toml
          test -d cib_med
          test -d tests
          test -d configs
